# 移动端H5页面调试

## 一、Android端

### 1. 通过手机端的Chrome浏览器

#### 前置要求

- Android 4.4以上

- 手机开启”开发者选项“，并打开“USB调试”

  <img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/f6c572afec4f4c2b8ae945de2c12d2f4.png" alt="image-20240326141046232" style="zoom:50%;" />

- 安装“adb”（Android Debug Bridge，可选）

#### 操作步骤

1. 通过手机端chrome访问待调试的页面，手机通过USB连接电脑

2. PC端chrome中访问`chrome://inspect`，如果设备是首次连接调试会弹出如下提示，点击“确认”即可

   <img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/b5b8bc8ecb974363bebbbec341fd74d5.png" alt="image-20240326141827507" style="zoom:50%;" />

3. PC端Chrome中可以查看到当前可调试的页面，点击需要调试页面下方的“inspect”即可打开单独的调试界面

   ![image-20240326142011232](https://oss.kuyinyun.com/11W2MYCO/rescloud1/c8881141ca1d4a648cc8187bff9e7efc.png)

   ![image-20240326142355707](https://oss.kuyinyun.com/11W2MYCO/rescloud1/7658e78493ac474cacfbc80094a41bfb.png)

   **这里需要注意一下，首次调试时可能需要科学上网才能打开这个调试界面**

### 2. 调试WebView中的页面

安卓4.4之后WebView默认使用的就是Chrome的内核，但要调试通过WebView加载的页面，还需要WebView开启debug开关

```java
 WebView.setWebContentsDebuggingEnabled(true);
```

开启之后，调试的方式是一致的

![image-20240326143558983](https://oss.kuyinyun.com/11W2MYCO/rescloud1/ef6a3e0d29404b6692f8f2c2d96a4ec2.png)

这里我自己写了一个WebView的Demo，并且开启了debug开关，打开应用后，可以手动填入页面地址或扫二维码的方式打开页面

![image-20240326143850710](https://oss.kuyinyun.com/11W2MYCO/rescloud1/f087219d630a46bda28454243c07b8bf.png)

该apk包的[安装地址](https://kuyin.iflysec.com/ycyu/webview/app-debug.apk)

## 二、iOS端

### 1. 通过Safari

#### 前置条件

1. 需要一台mac……
2. 一根适配的usb连接线（有的线虽然可以充电，但无法连接并调试页面）

#### 操作步骤

1. 设置iphone上的safari：设置 --> Safari浏览器 --> 高级 --> 启用“网页检查器”

2. 手机通过safari访问待调试的页面，并通过usb与mac相连

3. mac上打开safari，并在设置 --> 高级 --> 勾选“显示网页开发者功能”，之后就可以在菜单中看到手机端的待调试页面，点击之后就可以开启一个单独的调试界面

   ![image-20240326151627863](https://oss.kuyinyun.com/11W2MYCO/rescloud1/f70b8e511b474b2d861494c815f68bd1.png)

   ![image-20240326151710676](https://oss.kuyinyun.com/11W2MYCO/rescloud1/bafd9b77bee349cfa15b16bd4c224640.png)



## 三、通用

### 1. JavaScript Lib——在页面端直接创建调试面板

这种以[vConsole](https://github.com/Tencent/vConsole)和[Eruda](https://github.com/liriliri/eruda)为代表，使用起来比较简单，基本只需要在页面端引用js文件，然后进行初始化，具体的使用可以参见各自的官网，功能相对有限

![img](https://oss.kuyinyun.com/11W2MYCO/rescloud1/8509fd5bf801440f9d87ad9af7531966.jpeg)

下图中，左侧为vConsole的调试界面，右侧为Eruda的调试界面

<center>
<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/652105f9cb11481ab359a0f77a95c64d.png" alt="image-20240326152926452" style="zoom:25%;" />
<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/ce9b39b5c1e44dc99516c5a2e0deb126.png" alt="image-20240326152758146" style="zoom:25%;" />
</center>





### 2. weiner类似产品

此类调试方式最早接触的产品就是[weinre](https://people.apache.org/~pmuellr/weinre/docs/latest/)，但项目已经不再维护了，有兴趣的可以去试试，这里只介绍几个类似的替代产品

#### 2.1 [chii](https://github.com/liriliri/chii?tab=readme-ov-file)

![img](https://oss.kuyinyun.com/11W2MYCO/rescloud1/cfea09104eab46c78bcd09556f58207c.jpeg)

它的前端调试界面使用的是最新的chrome devtools frontend，远程调试的效果如下，左侧就是调试的界面，右侧是另一个工具，展示的是我手机上的镜像，用于演示当查看DOM元素时，手机端也会对应的高亮（利用了chrome devtools frontend提供的能力）

![image-20240326160818933](https://oss.kuyinyun.com/11W2MYCO/rescloud1/f1a5d70b75e24181ba797e35990025b4.png)

#### 2.2 [whistle](https://github.com/avwo/whistle) + whistle.chii插件

还有对应的[客户端版本](https://github.com/avwo/whistle-client)

参考文章：

https://juejin.cn/post/7277395050509353017

https://juejin.cn/post/6844903592424374285

### 3. PageSpy

项目地址：https://github.com/HuolalaTech/page-spy-web

#### 3.1 安装 && 启动

```bash
npm install -g @huolala-tech/page-spy-api@latest
page-spy-api
# 然后访问，开发环境地址：http://172.31.114.108:6752
```

#### 3.2 nginx调整

```nginx
location ~* ^/page-spy/(api|plugin)/ {
		rewrite /page-spy/(.*)$ /$1 break;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_pass http://172.31.114.108:6752;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_http_version 1.1;
}
location ~* ^/page-spy/ {
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_pass http://172.31.114.108:6752;
}
```

#### 3.3 配置

```html
<script crossorigin="anonymous" src="https://kuyin.iflysec.com/page-spy/index.min.js"></script>
<script crossorigin="anonymous" src="https://kuyin.iflysec.com/page-spy/plugin/data-harbor/index.min.js"></script>
<script crossorigin="anonymous" src="https://kuyin.iflysec.com/page-spy/plugin/rrweb/index.min.js"></script>
<script>
  PageSpy.registerPlugin(new DataHarborPlugin());
  PageSpy.registerPlugin(new RRWebPlugin());
  window.$pageSpy = new PageSpy({
    api: 'kuyin.iflysec.com/page-spy',
    clientOrigin: 'https://kuyin.iflysec.com/page-spy',
    project: 'h5-act-tpl-selectedtopics',
    title: '520活动',
  });
</script>
```

#### 3.4 访问页面

手机端：

**PC端：控制端**

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/1e3535a7c66148d78c18b4d404168706.png" alt="image-20240529154650757" style="zoom:50%;" />

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/8bae7a9e58b24c9ba3f86cdf95afbf93.png" alt="image-20240529163600904" style="zoom:50%;" />

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/8d1ac6a933d34225804a9bec87a18825.png" alt="image-20240529163637482" style="zoom:50%;" />

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/5420c1680e514062bfe5a68db9049ccb.png" alt="image-20240529173044156" style="zoom:50%;" />

### 4. 微信端内调度

对于安卓端，可以在微信内访问一下http://debugxweb.qq.com/?inspector=true，如果页面正常加载之后，就可以通过USB连接电脑端的chrome进行调试了

![image-20240626161348551](https://oss.kuyinyun.com/11W2MYCO/rescloud1/88f4128aa13e47a1a84c0443becbe4aa.png)



## 四、关于抓包

### 0. 说明

- 这里提到的抓包方法不包括上述调试方法中涉及查看网络请求的部分
- 以Mac OS举例（Windows的操作步骤类似）
- 电脑端使用的抓包工具为Charles（Fiddler的操作步骤类似）
- 部分场景下会使用tcpdump来进行抓包

### 1. iOS端

#### 1.1 安装Charles（略）

#### 1.2 配置Charles根证书

##### PC端

如图选择“Install Charles Root Certificate”，在PC端安装Charles的根证书，点击之后会启动Mac的“钥匙串访问”应用，完成安装之后可以看到目前Mac还是不信任Charles的证书的，双击证书，在弹出的界面中选择始终信任，到此PC端的配置就算完成了

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/5bb8b32bfcd14592bd8c20fdfa2220a8.png" alt="image-20240527110024950" style="zoom:50%;" />

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/deaa1d3fe472414b9022d06382f6cd9c.png" alt="image-20240527111314079" style="zoom:50%;" />

##### 手机端

保持手机与PC处于同一个局域网，然后打后手机端的WIFI配置，配置HTTP代理为“手动“模式，并填入服务器的IP地址（即PC端IP，因为这里是将PC端作为一个中间服务器，如何查看IP地址？）及端口（Charles中默认是8888端口），端口号可以在Charles的“Proxy Settings”中查看

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/262e21eeaeec474dbc15b7640cbd409f.png" alt="image-20240527112621535" style="zoom:50%;" />

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/c85b2683707041ec803fa3c20869041e.png" alt="image-20240527112505790" style="zoom:50%;" />

手机端完成上述设置之后，接着在Charles中选择“Install Charles Root Certificate on a Mobile Device or Remote Browser”，此时会提示如下（这里也可以看到本地的IP地址）：

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/21fe586775254bf79300eb2aff844d21.png" alt="image-20240527112810764" style="zoom:50%;" />

在手机端浏览器中访问`chls.pro/ssl`会提示下载描述文件，接着就是按上图中的提示，在手机的设置中信任所下载的这个证书：



接着在手机端访问需要抓包的页面（包括https的链接），即可在PC端的Charles中看到请求的明细，这里有个**细节的配置**：默认情况下对于https的域名，并未开启“SSL Proxying”，也就是看不到请求的详情，需要在Charles中右键的某条请求，然后选择“Enable SSL Proxying”，如果觉得这样操作麻烦，可以直接在Charles中的“SSL Proxying Settings”中配置针对所有域名开启https的抓包：

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/bd23764ea26243978c0017462fe1fa06.png" alt="image-20240527113717667" style="zoom:50%;" />

#### 1.3 通过USB来抓包

对于某些特定的场景，手机与PC无法设置为处于同一局域网环境，此时可以通过该方法来抓包，手机通过USB链接电脑，在手机上点击“信任当前设备”后就可以在Finder中看到手机的具体信息，单击设备名称后就可以查看手机的UDID（如果看不到点击“iPhone12下方的小字”）：

![image-20240529094349916](https://oss.kuyinyun.com/11W2MYCO/rescloud1/283a0442bc9b4f85a377a4dcf817d505.png)

右键“UDID”区域进行拷贝

使用命令`rvictl -s <device_udid>`创建一个**远程虚拟接口**，执行之后你会得到一个**虚拟网络接口**，比如：rvi0

![image-20240529094631951](https://oss.kuyinyun.com/11W2MYCO/rescloud1/c58a5664c4a44d6fb1ccbe40a91ab6e8.png)

之后通过`ifconfig`就可以查看到该虚拟网络接口，接下来就可以利用`tcpdump -i rvi0 -w trace.pcap`来进行抓包，抓包记录保存到`trace.pcap`中，后续可以使用Wireshark这样的工具来分析抓包记录

![image-20240529102252210](https://oss.kuyinyun.com/11W2MYCO/rescloud1/cf61e12737af4ca3b1c2c11f4194bf4c.png)

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/395a817da8da48579d0260b7dfc140d5.png" alt="image-20240529103917505" style="zoom:50%;" />

**但这种方式有个最大的问题，不支持HTTPS**，因为HTTPS涉及加解密，通过虚拟网络接口的方式目前无法处理这种情况，所以建议对于HTTPS请求，还是使用上文联调部分的Charles来查看（毕竟iOS没有安装证书的限制）

结束抓包后，通过命令`rvictl -x <device_udid>`来删除虚拟网络接口

#### 1.4 Wireshark中如何查看HTTPS及HTTP2的包

在不使用虚拟网络端口的情况下，能不能通过tcpdump来分析HTTPS的包呢，答案是肯定的

如前文HTTPS的内容是经过加密处理的，Wireshark解密数据包的办法是通过分析TLS握手的日志来拿到解密数据包的关键信息，这个通过一个环境变量来处理的：SSLKEYLOGFILE

大概的过程是：在发送请求时，指定该环境变量，保存TLS握手相关的日志，然后在Wireshark中配置该日志的地址，就可以解析HTTP2/HTTPS的包了

假设日志存储的位置为：`/Users/yudiechao/tls/tls.log`，则在Wireshark中，可以通过：Preference -> Protocols -> TLS 面板的选项中指定：

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/dc84827dcd5a402ca7db9b1bace5c328.png" alt="image-20240529112125944" style="zoom:50%;" />

接下来就是指定客户端在发送请求时，将TLS握手相关的日志记录到该位置即可，我们先以`curl`为例，假设请求地址为`https://iring.diyring.cc/friend/de4f54d6f65e85cc`，为了避免Wireshark中展示太多的日志，可以针对IP进行一下过滤，域名`iring.diyring.cc`的IP地址为`114.118.64.64`，则Wireshark中过滤表达式可以为：`ip.src == 114.118.64.64 || ip.dst == 114.118.64.64`

##### 使用curl

终端执行：`SSLKEYLOGFILE=/Users/yudiechao/tls/tls.log curl -v"https://iring.diyring.cc/friend/de4f54d6f65e85cc"`

在Wireshark中就可以看到相关的日志，为了方便查看，这里我们过滤掉非HTTP2的请求：

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/0ee9bfcc014941b698de93827ea1dd2c.png" alt="image-20240529113608580" style="zoom:50%;" />

##### 使用chrome

这里我用的是Chrome Canary版本，所以终端中执行的命令是：`SSLKEYLOGFILE=/Users/yudiechao/tls/tls.log open /Applications/Google\ Chrome\ Canary.app/Contents/MacOS/Google\ Chrome\ Canary`

*PS：这里通过终端来启动是为了让环境变量生效*

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/1e6d3af419c14554921e984729b9e750.png" alt="image-20240529115545530" style="zoom:50%;" />

通过右键可以将ajax响应的具体内容复制出来查看，但测试直接拷贝纯文本，对于中文会乱码，我这里是作为base64字符串拷贝，然后使用DevToys这样的工具解码成json字符串，再格式化方便查看

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/a2c8a8b38edc4698a937a8bdba05f710.png" alt="image-20240529115823794" style="zoom:50%;" />

<img src="https://oss.kuyinyun.com/11W2MYCO/rescloud1/bdbb617bced44046a96dad222d9a57c8.png" alt="image-20240529115939049" style="zoom:50%;" />

PS：如果对上述提到的TLS握手相关的日志感兴趣，可以去查看文件的内容，纯文本，研究一下其中各字段的意义

### 2. Android端

#### 2.1 Root

Android在7.0之后进行了网络安全这块的加固，如果要抓https的包，就必须让系统信任Charles的证书，而要做到这一点，首先要root系统，再配合如Magisk这样的工具来把证书安装到系统区，另外国内手机各厂商的root方式不相同，这一步的操作成本会比较大，之前将小米MIUI 14进行了root，并配合Magisk及其插件，在手机重启时将用户区中的证书移动到系统区，从而让系统信任Charles的证书，并实现https请求的抓包……考虑到实施的复杂程度以及各厂商的处理方式不同，这里就不介绍的，有兴趣的自行尝试（光是关于Magisk可能就要单独的一篇文章来介绍了）

#### 2.2 信任用户区的证书

前面在介绍安卓端的WebView调试时提到我们自己开发了一个仅封装了一个WebView的小App，它其中做了一些应用级别的配置，来使其信息用户区的证书：

AndroidManifest.xml

```xml
<application
        android:networkSecurityConfig="@xml/network_security_config"
        ...
```

network_security_config.xml

```xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <base-config>
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </base-config>
</network-security-config>
```

其中`<certificates src="user" />`就表示让应用信任用户区的证书，这样设置之后在该应用内就可以通过前文提到的中间人的方式来抓取https的包（因为场景的限制，这种方式其实有些鸡肋……就当是扩充知识面了）

